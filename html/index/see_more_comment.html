<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"/>

    <title>查看评论详情</title>
    <link rel="stylesheet" href="../../css/mui.min.css"/>
    <link rel="stylesheet" href="../../css/mui_img.css"/>
    <link rel="stylesheet" href="../../css/base.css"/>
    <link rel="stylesheet" href="../../css/sweetalert2.css"/>
    <link rel="stylesheet" href="../../css/iconfont.css"/>
    <link rel="stylesheet" href="../../css/header.css"/>
    <link rel="stylesheet" href="../../css/icons-extra.css"/>
    <link rel="stylesheet" href="../../css/find/find_dynamic.css"/>
    <style>
        .layer>header>i{
            top: 40%;
            color:#fff;
        }
        .layer>header>h3{
            line-height: 1rem;
        }
        .main{

            padding-top: 0.2rem;
        }
        .All_lists{
            padding: 0 0.3rem;
        }
        .All_lists>.All_list{
            border-bottom: none;
        }
        .layer .main > .response {
            height: 1rem;
            width: 100%;
            line-height: 1rem;
            background-color: #f01414;
            position: fixed;
            bottom: 0;
            z-index: 1;
        }
        .layer .main > .response > input {
            width: 70%;
            height: 0.9rem;
            background-color: #aa1211;
            margin-left: 0.2rem;
            text-indent: 1em;
            color:#fff;
        }
        .layer .main > .response:before {
            width: 0.5rem;
            height: 0.5rem;
            content: '';
            position: absolute;
            left: 3%;
            top: 30%;
            background: url("../../img/edit.png") no-repeat center;
            -webkit-background-size: 100%;
            background-size: 100%;
        }
        .layer .main > .response > span {
            width: 25%;
            display: inline-block;
            color: #fff;
            text-align: center;
        }
        .All_list>.list_content>.tit{
            display: block;
        }
        .comment_box>.comments_father>.reply {
            font-size: 0.26rem;
            color:#999;

        }
        .comment_box>.comments_father>.reply>i,.comment_box>.comments_father>.reply>s{
            color:#00204c;
        }
        .comment_box>.comments_father{
            border-bottom: 1px solid #eee;
            padding: 0.2rem 0;
        }
        .comment_box>.comments_father>.son{
            padding-left: 0.5rem;
        }
    </style>
</head>
<body style="background-color:#fff;overflow-x: hidden">
<div class="layer">
    <header>
        <i onclick="back()" class="mui-icon mui-icon-back"></i>
        <h3>动态详情</h3>
    </header>
    <div class="main">
        <div class="All_lists">
          <!--  <div class="All_list">
                <div class="list_top">
                    <img src="../../img/focus-img1.png" alt="">
                    <div class="list_top_center clearfix">
                        <em>傅娟
                            <s class="f_right">1小时前</s>
                        </em>
                        <p>华南师范大学附属中学华南师范大学附属中学华南师范大学附属中学数学教师华南师范大学附属中学华南师范大学附属中学华南师范大学附属中学数学教师华南师范大学附属中学华南师范大学附属中学华南师范大学附属中学数学教师华南师范大学附属中学华南师范大学附属中学华南师范大学附属中学数学教师</p>
                    </div>
                </div>
                <div class="list_content clearfix">
                    <div class="tit">
                        明天开始新的一章数学学习，同学们做好预习哦明天开始新的一章数学学习，同学们做好预习哦明天开始新的一章数学学习，同学们做好预习哦明天开始新的一章数学学习，同学们做好预习哦明天开始新的一章数学学习，同学们做好预习哦明天开始新的一章数学学习，同学们做好预习哦明天开始新的一章数学学习，同学们做好预习哦明天开始新的一章数学学习，同学们做好预习哦明天开始新的一章数学学习，同学们做好预习哦明天开始新的一章数学学习，同学们做好预习哦明天开始新的一章数学学习，同学们做好预习哦
                    </div>
                    <div class="imgs">
                        &lt;!&ndash;注意类名 可能会与关注页面 重复&ndash;&gt;
                        <div class="img_box">
                            <img src="../../img/focus-img1.png" alt="" data-preview-src="" data-preview-group="1">
                        </div>
                        <div class="img_box">
                            <img src="../../img/focus-img1.png" alt="" data-preview-src="" data-preview-group="1">
                        </div>
                        <div class="img_box">
                            <img src="../../img/focus-img1.png" alt="" data-preview-src="" data-preview-group="1">
                        </div>
                        <div class="img_box">
                            <img src="../../img/focus-img1.png" alt="" data-preview-src="" data-preview-group="1">
                        </div>
                    </div>
                </div>
                <div class="list_content_footer clearfix">
                    <ul class="clearfix">
                        <li>浏览123次</li>
                        <li><em class="iconfont icon-zhuanfa">120</em></li>
                        <li><em class="iconfont icon-xiaoxi">20</em></li>
                        <li><em class="iconfont icon-like">150</em></li>
                    </ul>
                    <div class="comment_box">
                        &lt;!&ndash;判断有没有回复人 渲染出来两句回复就可以了&ndash;&gt;
                        <p>
                            <i>魏雨</i>&nbsp;:&nbsp;&nbsp;
                            真是一个真实一个爱学习的孩子啊！真实一个爱学习的孩子啊！  真是一个真实一个爱学习的孩子啊！真实一个爱学习的孩子啊！
                        </p>
                        <p>
                            <i>亚楠</i>&nbsp;&nbsp;回复
                            <s>傅娟</s>&nbsp;&nbsp;:&nbsp;&nbsp;哈哈，谢谢夸奖
                        </p>
                       </div>
                </div>
            </div>-->

        </div>
        <div class="response">
            <input type="text" placeholder="我要回复"/>
            <span class="finish">
                完成
            </span>
        </div>
    </div>
</div>
</body>
<script src="../../js/mui.min.js"></script>
<script src="../../js/mui.zoom.js"></script>
<script src="../../js/mui.preview.js"></script>
<script src="../../js/x_rem.js"></script>
<script src="../../js/jquery.min.js"></script>
<script src="../../js/fastclick.js"></script>
<script src="../../js/base.js"></script>
<script src="../../js/back.js"></script>
<script src="../../js/sweetalert2.js"></script>
<script src="../../js/template-web.js"></script>
<script src="../../js/template.js"></script>
<script id="detail" type="text/html">
    <div class="All_list">
        <div class="list_top">
            {{if data.user.portrait==null}}
            <img src="../../img/logo.png" alt="">
            {{else}}
            <img src="{{data.user.portrait}}" alt=""/>
            {{/if}}
            <div class="list_top_center clearfix">
                <em>{{data.user.nickname==null?data.user.realName==null?"猴姆教学":data.user.realName:data.user.nickname}}
                    <s class="f_right">{{time(data.dynamic.updateTime)}}</s>
                </em>
                <p>{{data.school==null?"暂未完善学校":data.school}}</p>
            </div>
        </div>
        <div class="list_content clearfix">
            <div class="tit">
                {{data.dynamic.body}}
            </div>
            <div class="imgs">
                {{if data.dynamic.picture==null||data.dynamic.picture==""}}
                {{else}}
                {{each str(data.dynamic.picture) as img k}}
                <div class="img_box">
                    <img src="{{img}}" alt="" data-preview-src="" data-preview-group="1"/>
                </div>
                {{/each}}
                {{/if}}
            </div>
        </div>
        <div class="list_content_footer clearfix">
            <ul class="clearfix">
                <li>浏览{{data.dynamic.previewNum}}次</li>
                <li><em class="iconfont icon-zhuanfa"> 120</em></li>
                <li><em class="iconfont icon-xiaoxi"> {{data.listComment.length}}</em></li>
                <!--判断是否点赞-->
                {{if data.love.是否点赞 =="否"}}
                <li class="hand" data-id='{{data.dynamic.id}}'><em class="iconfont icon-like"> {{data.love.点赞总数}}</em></li>
                {{else}}
                <li  class="hand" data-id='{{data.dynamic.id}}'><em class="iconfont icon-like is_hand"> {{data.love.点赞总数}}</em></li>
                {{/if}}
            </ul>
        </div>
            {{if data.listComment.length !==0}}
            <div class="comment_box">
                <!--判断有没有回复人 渲染出来两句回复就可以了-->
                {{each data.listComment as comment i}}
                <div class="comments_father" data-parentid="{{comment[0].Id}}" >
                    {{each comment as value j}}
                    <!--回复的动态-->
                    {{if value.publisher}}
                    <p  class='reply father' data-id="{{value.userId}}" data-name="{{value.publisher}}" data-parentid="{{value.Id}}">
                        <i >{{value.publisher}}</i>&nbsp;:&nbsp;&nbsp;
                        {{value.body}}
                    </p>
                    {{/if}}
                    {{if value.reply}}
                    <p class='reply son' data-id="{{value.userId}}" data-name="{{value.reply}}">
                        <i>{{value.reply}}</i>&nbsp;&nbsp;回复
                        <s >{{value.replyTo}}</s>&nbsp;&nbsp;:&nbsp;&nbsp;{{value.body}}
                    </p>
                    {{/if}}

                    <!--回复的是个人 回复的动态-->
                    <!--回复的个人-->
                    {{/each}}
                </div>
                {{/each}}
            </div>
            {{/if}}

    </div>
</script>
<script>
    $(function () {
        mui.previewImage();
        mui('body').on('tap','a',function(){document.location.href=this.href;});
        //FastClick.attach(document.body);
        var href=location.href.split("=")[1];
        var userid=localStorage.getItem("this_userid")
        var  dyUid;
        render();
        function render(){
            myAjax({url:"/dynamic/find/Dynamic/details",data:{dynamicid:href,userid:userid},type:"post",async:false}, function (data) {
             console.log(data);
                if(data.status==200){
                    template.helper("str",function(str){
                        return str.split(",");
                    })
                    template.helper("time",function(time){
                        var timestamp=new Date().getTime();//当前时间戳
                        var kk=timestamp-time;//发表时的时间戳
                        var timea="";
                        var sec=parseInt(kk/1000);//秒
                        var min=parseInt(sec/60);//分
                        var hour=parseInt(min/60);//时
                        var day=parseInt(hour/24);//天
                        if(sec<60){
                            timea=sec+"秒前";
                        }else if(min<60){
                            timea=min+"分钟前";
                        }else if(hour<24){
                            timea=hour+"小时前";
                        }else if(day<7){
                            timea=day+"天前";
                        }else{
                            timea=new Date(time).toLocaleString().replace(/:\d{1,2}$/,' ').replace(/\//g,"-");
                        }
                        return timea;

                    });
                    $(".All_lists").html(template("detail",data));
                    dyUid=data.data.dynamic.userId;
                    //点赞
                    $(".hand").click(function () {
                        var id=$(this).data("id");
                        console.log(id);
                        loveDynamic(id,this);
                    })
                    /*点赞*/
                    function loveDynamic(id,e){
                        myAjax({url:"/dynamic/update/Love/Dynamic",data:{"userid":userid,"dynamicid":id},type:"post",async:false}, function (data) {
                            console.log(data);
                            if(data.status==200){
                                if(data.data.love.是否点赞=="否"){
                                    /*去掉类名*/
                                    $(e).children("em").removeClass("is_hand");
                                    $(e).children("em").text(" "+data.data.love.点赞总数);
                                }else{
                                    $(e).children("em").addClass("is_hand");
                                    $(e).children("em").text(" "+data.data.love.点赞总数);
                                }
                                //重绘页面不行了
                                /* dynamic(1,3,localStorage.getItem("this_userid"));*/
                            }
                        })
                    }

                }
            })
        }
        var falg=true;
        // 回复评论
        var id;
        var parentId;
        //委托的 元素不能是渲染出来的元素 委托给任何非渲染的元素即可
        $(".All_lists").on('click',".reply",function(){
            //console.log(234321);
            falg=false;
            var name=$(this).data("name");
            // console.log(name);
            id=$(this).data("id");
            // console.log(id);
            parentId=$(this).closest(".comments_father").data("parentid");
           // parentId=$(this).data("parentid");
            //console.log(parentId);
            $("input").attr("placeholder",": "+name);
        });
        $(".finish").click(function () {//发送
            if($("input").val().trim().length==0){
                sweetAlert(
                        "sorry",
                        "对不起，不能够评论空内容哦",
                        "error"
                )
                return false;
            }
            var obj={};
            if(falg){
                /*回复的是动态*/
                obj.dynamicId=href;
                obj.dynamicOwnerid=dyUid;
                obj.user2Id=0;
                obj.parentId=0;
                obj.userId=userid;
                obj.body=$("input").val().trim();
                console.log(obj);
            }else{
                obj.dynamicId=href;
                obj.dynamicOwnerid=dyUid;
                obj.user2Id=id;
                obj.parentId= parentId;
                obj.userId=userid;
                obj.body=$("input").val().trim();
                console.log(obj);
            }
            myAjax({url:"/dynamic/add/Comment",type:"post",data:obj}, function (data) {
                console.log(data);

                if(data.status==200){
                    //render();不重绘页面 追加
                    falg=true;
                    obj={};
                    render();
                    $("input").val("");
                    $("input").attr("placeholder","");

                }
            })
        })
        /*增加浏览次数*/
        // /dynamic/add/preview/num
        preview(href);
        function preview(id){
          myAjax({url:"/dynamic/add/preview/num",data:{dynamicid:id},type:"post"}, function (data) {
              console.log(data);
              if(data.status==200){
                  console.log("增加了浏览次数");
              }
          })
        }
        $('.All_lists').scrollTop($('.main')[0].scrollHeight);
    })
</script>
</html>