<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"/>

    <title>  教务管理</title>

    <link rel="stylesheet" href="../../css/mui.min.css"/>
    <link rel="stylesheet" href="../../css/base.css"/>
    <link rel="stylesheet" href="../../css/sweetalert2.css"/>
    <link rel="stylesheet" href="../../css/iconfont.css"/>
    <link rel="stylesheet" href="../../css/header.css"/>
    <link rel="stylesheet" href="../../css/mine/edu_admin.css"/>
</head>
<body>
<div class="layer">
    <header id="header" class="mui-bar mui-bar-nav">
        <i class="mui-icon mui-icon-left-nav mui-pull-left" onclick="back()"></i>
        <h1 class="mui-title">教务管理</h1>
        <em class="iconfont icon-9" onclick="location.href='edu_common_question.html'"></em>
    </header>
    <div class="main" style="overflow-x: hidden">
        <div id="slider" class="mui-slider ">
            <div style="padding: 10px 0px;">
                <div id="segmentedControl" class="mui-segmented-control">
                    <a class="mui-control-item mui-active" href="#item1">
                        <span>视频上传</span>
                    </a>
                    <a class="mui-control-item" href="#item2">
                        <span>我的视频</span>
                    </a>
                </div>
            </div>
            <!--文件选择按钮-->
            <a class="list_video" href="javascript:;">
                <div id="video_content">
                    <!-- 获取不到 avi qsv 获取到的mkv MP4-->
                  <!--<input id="file" type="file" accept="video/*" name="myfile" onchange="UpladFile();" />-->
                    <input id="file" type="file"  name="myfile" onchange="UpladFile();"/>
                </div>
            </a>
        </div>
        <div class="main_content">
            <!-- //把外层的div 去掉就能正常的跳转了-->
            <!--全部-->
            <div id="item1" class="mui-control-content mui-active">
                <h2>
                    <i>视频列表</i>
                    <em data-type="0">未编辑</em>
                    <em data-type="1">已编辑</em>
                    <em class="active" data-type="2">全部</em>
                </h2>
                <div class="no_upload" style="display: none;">
                <div class="load_tit" >
                    <span>HD</span>
                    <em id="videoName">0.125555.mov</em>
                    <i class="quit_upload"  onclick="sub();">上传</i>
                    <!--<i class="quit_upload">取消</i>-->
                </div>
                    <video src="" style="display: none" id="videoId" oncanplaythrough="myFunction(this)"></video>
                <!--进度条-->
                <div class="el-progress el-progress--line" style="display: block;">
                    <div class="el-progress-bar">
                        <div class="el-progress-bar__outer" style="height:8px;">
                            <div class="el-progress-bar__inner" style="width: 0%;">
                            </div>
                        </div>
                    </div>
                    <div class="el-progress__text">0%</div>
                    <p id="time"> </p>
                </div>

            </div>
                <ul class="video_lists">
                    <!--上传未完成-->
                    <!--未编辑-->
                 <!--   <li class="upload_success">
                        <div class="load_tit">
                            <span>HD</span>
                           <em>20180716183621.mov -2018/07/16 18:36</em>
                            <i>完成上传</i>
                        </div>
                        <div class="operation">
                            <button class="quit">移除</button>
                            <button class="edit" onclick="location.href='editClass.html'">编入课程</button>
                        </div>

                    </li>-->
                   <!-- <li class="upload_success">
                        <div class="load_tit">
                            <span>HD</span>
                           <em>20180716183621.mov -2018/07/16 18:36</em>
                            <i>完成上传</i>
                        </div>
                        <div class="operation">
                            <button class="remove">移除</button>
                            <button class="haveEditClass">已编入课程</button>
                            <button class="editClass" onclick="location.href='./my_video_class_edit.html'">课程编辑</button>
                        </div>

                    </li>
                    <li class="upload_success">
                        <div class="load_tit">
                            <span>HD</span>
                           <em>20180716183621.mov -2018/07/16 18:36</em>
                            <i>完成上传</i>
                        </div>
                        <div class="operation">
                            <button class="putaway">已上架</button>
                            <button class="editC" onclick="location.href='./my_video_class_edit.html'">课程编辑</button>
                        </div>

                    </li>-->
                </ul>
            </div>
            <div id="item2" class="mui-control-content ">
                <div class="account_tit">
                    <h2>课程列表</h2>
                    <div class="lesson_status">
                        <em>结课状态</em>
                        <span data-classEndingStatus="0" class="active">全部</span>
                        <span data-classEndingStatus="1">未结课</span>
                        <span data-classEndingStatus="2">已结课</span>
                    </div>
                    <div class="publish_status">
                        <em>发布状态</em>
                        <span data-releaseStatus="0" class="active">全部</span>
                        <span data-releaseStatus="1">未发布</span>
                        <span data-releaseStatus="2">已发布</span>
                    </div>
                </div>
                <div class="my_video_lists">
                  <!--  <div class="list">
                        <span>未发布</span>
                        <h4>2018年初二化学上期课堂 <i>未结课</i></h4>
                        <p>
                            <del class="delete iconfont icon-htmal5icon17"></del>
                            华南师范大学附属中学
                            <i>共10课时，<s>2</s> 课时未上架</i></p>
                        <div class="list_b clearfix" onclick="location.href='./editClass.html'">
                        &lt;!&ndash;<div class="list_b clearfix" onclick="location.href='./my_video_class_edit.html'">&ndash;&gt;
                            <span>最新编辑 2018.07.23</span>
                            <i class="mui-icon mui-icon-forward f_right"></i>
                        </div>
                    </div>
                    <div class="list has_publish">
                        <span>已发布</span>
                        <h4>2018年初二化学上期课堂 <i>未结课</i></h4>
                        <p>
                            <del class="delete iconfont icon-htmal5icon17"></del>
                            华南师范大学附属中学
                            <i>共10课时，<s>2</s> 课时未上架</i></p>
                        <div class="list_b clearfix" onclick="location.href='./editClass.html'">
                            <span>最新编辑 2018.07.23</span>
                            <i class="mui-icon mui-icon-forward f_right"></i>
                        </div>
                    </div>-->
                </div>

            </div>

        </div>
</div>
</div>
</body>
<script src="../../js/mui.min.js"></script>
<script src="../../js/x_rem.js"></script>
<script src="../../js/jquery.min.js"></script>
<script src="../../js/base.js"></script>
<script src="../../js/back.js"></script>
<script src="../../js/sweetalert2.js"></script>
<script src="../../js/template-web.js"></script>
<script src="../../js/template.js"></script>
<!--未编辑-->
<script type="text/html" id="my_video">
{{if data==""||data==null ||data.length==0}}
<div class="no_in"> 对不起，您暂时没有视频展示</div>
{{else}}
{{each data as value i}}
{{if value.status==0}}
<!--未编入课程-->
<li class="upload_success">
    <div class="load_tit">
        <span>HD</span>
        <em>{{value.fileName}} -{{time(value.uploadTime)}}</em>
        <i>完成上传</i>
    </div>
    <div class="operation">
        <button class="quit" data-id="{{value.id}}" onclick="deletePer('{{value.id}}',this)">移除</button>
        <button class="edit" onclick="location.href='editClass.html?id={{value.id}}'">编入课程</button>
    </div>
</li>
 {{else}}
        <!--上架-->
        {{if value.status==1}}
        <li class="upload_success">
            <div class="load_tit">
                <span>HD</span>
                <em>{{value.fileName}} -{{time(value.uploadTime)}}</em>
                <i>完成上传</i>
            </div>
            <div class="operation">
                <button class="remove" onclick="outCourse('{{value.id}}',this)">移除</button>
                <button class="haveEditClass">已编入课程</button>
                <button class="editClass" onclick="location.href='./my_video_class_edit.html?id={{value.courseId}}'">课程编辑</button>
            </div>
        </li>
                {{else}}
                <li class="upload_success">
                    <div class="load_tit">
                        <span>HD</span>
                        <em>{{value.fileName}} -{{time(value.uploadTime)}}</em>
                        <i>完成上传</i>
                    </div>
                    <div class="operation">
                        <button class="putaway">已上架</button>
                        <button class="editC" onclick="location.href='./my_video_class_edit.html?id={{value.courseId}}'">课程编辑</button>
                    </div>

                </li>
            <!---->
        {{/if}}

{{/if}}

{{/each}}
    {{/if}}
</script>
<script id="mine" type="text/html">
{{if data==""||data==null ||data.length==0}}
<div class="no_in"> 对不起，您暂时没有视频展示</div>
{{else}}
{{each data as value i}}
{{if value.coures.releaseStatus==1}}
<div class="list">
    <span>未发布</span>
    <h4>{{value.coures.academicYear}}{{value.coures.grade}}{{value.coures.subject}}{{value.coures.semester}} <i>{{value.coures.classEndingStatus==1?"未结课":"已结课"}}</i></h4>
    <p>
        {{value.coures.schoolName}}
        <i>共{{sum(value.LowerShelfNum,value.UpperShelfNum)}}课时，<s>{{value.LowerShelfNum}}</s> 课时未上架</i></p>
    <div class="list_b clearfix" >
        <!--<div class="list_b clearfix" onclick="location.href='./my_video_class_edit.html'">-->
        <span>最新编辑 {{time(value.coures.updateTime)}}</span>
        <em class="f_right">已上架{{value.UpperShelfNum}}课时</em>
    </div>
</div>
{{else}}
<div class="list has_publish">
    <span>已发布</span>
    <h4>{{value.coures.academicYear}}{{value.coures.grade}}{{value.coures.subject}}{{value.coures.semester}} <i>{{value.coures.classEndingStatus==1?"未结课":"已结课"}}</i></h4>
    <p>
        {{value.coures.schoolName}}
        <i>共{{sum(value.LowerShelfNum,value.UpperShelfNum)}}课时，<s>{{value.LowerShelfNum}}</s> 课时未上架</i></p>
    <div class="list_b clearfix" >
        <!--<div class="list_b clearfix" onclick="location.href='./my_video_class_edit.html'">-->
        <span>最新编辑 {{time(value.coures.updateTime)}}</span>
        <em class="f_right">已上架{{value.UpperShelfNum}}课时</em>
    </div>
</div>
{{/if}}
{{/each}}
    {{/if}}
</script>
<script>
    //教师的id
    var teacherId=localStorage.getItem("this_userid");
    //移除为编辑视频 相当于删除
    function deletePer(id,e){
        myAjax({url:"/period/related/delete/Period",data:{periodid:id},type:"post"}, function (data) {
            console.log(data);
            if(data.status==200){
                $(e).text("已移除");
            }
        })
    }
    // 已编辑的课程 移除课程
    function outCourse(id,e){
        myAjax({url:"/period/related/update/outCourse",data:{periodid:id},type:"post"}, function (data) {
            console.log(data);
            if(data.status==200){
                $(e).text("已移除");
            }
        })
    }

    // video 的时长
    var video_time=0;
    function myFunction(ele) {
        var hour = parseInt((ele.duration)/3600);
        var minute = parseInt((ele.duration%3600)/60);
        var second = Math.ceil(ele.duration%60);

        video_time=ele.duration;
        console.log(video_time);
        //console.log(Math.floor(ele.duration));
        //document.write("这段视频的时长为："+hour+"小时，"+minute+"分，"+second+"秒");
       // document.getElementById("getDuration").innerHTML="这段视频的时长为："+hour+"小时，"+minute+"分，"+second+"秒";
    }
    var xhr;//异步请求对象
    var ot; //时间
    var oloaded;//大小
    var imgUrl;
    //上传文件方法
    function UpladFile() {
        var fileObj = document.getElementById("file").files[0]; // js 获取文件对象
        $(".no_upload").show();
        if (fileObj.name) {
            $("#videoName").text(fileObj.name);
            //视频时长
            var video_url = URL.createObjectURL(fileObj);
            document.getElementById("videoId").src = video_url;
            console.log(video_url);
        } else {
            alert("请选择文件");
        }
        // 获取第一帧
        //选择视频后展示视频
        var video = document.getElementById("videoId");
        var scale = 0.8;
        var initialize = function() {
            video.addEventListener('loadeddata',captureImage);
        };

        var captureImage = function() {
            var canvas = document.createElement("canvas");
            canvas.width = video.videoWidth * scale;
            canvas.height = video.videoHeight * scale;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            imgUrl=canvas.toDataURL("image/png");
            console.log(canvas.toDataURL("image/png"));
            /*var img = document.createElement("img");
            img.src = canvas.toDataURL("image/png");
            output.appendChild(img);*/
        };
        initialize();
    }
    /*点击提交*/
    function sub(){
        var fileObj = document.getElementById("file").files[0]; // js 获取文件对象
        if(fileObj==undefined||fileObj==""){
            return alert("请选择文件");
        };
        //      视频大小判断
        if(fileObj.size>=100000*1024*1024){
            return alert("文件太大了,请您压缩处理后再次上传");
        }
       /* var url = baseUrl+"/pic/file/upload"; // 接收上传文件的后台地址
        var form = new FormData(); // FormData 对象
        var token=localStorage.getItem("token");
        console.log(video_time);
        form.append("token", token); // 文件对象
        form.append("file", fileObj); // 文件对象
        /!* form.append("fileDuration",parseInt(video_time*1000));//转成 毫秒 视频时长
         form.append("periodPicture",img_url);//视频时长
         form.append("teacherId",teacherId);*!/
        console.log(form);
        xhr = new XMLHttpRequest(); // XMLHttpRequest 对象
        xhr.open("post",url, true); //post方式，url为服务器请求地址，true 该参数规定请求是否异步处理。
        xhr.onload = uploadComplete; //请求完成
        xhr.onerror = uploadFailed; //请求失败
        xhr.upload.onprogress = progressFunction;//【上传进度调用方法实现】
        xhr.upload.onloadstart = function() { //上传开始执行方法
            ot = new Date().getTime(); //设置上传开始时间
            oloaded = 0; //设置上传开始时，以上传的文件大小为0
        };
        xhr.send(form); //开始上传，发送form数据*/

         setTimeout(function () {
             myAjax({url:"/pic/base64/upload",data:{base64:imgUrl},type:"post"}, function (data) {
                 console.log(data);
                 if(data.status==200){
                     var img_url=data.data;
                     //var img_url="";
                     var url = baseUrl+"/period/related/upload/period"; // 接收上传文件的后台地址
                     //var url = baseUrl+"/pic/file/upload"; // 接收上传文件的后台地址
                     var form = new FormData(); // FormData 对象
                     var token=localStorage.getItem("token");
                     console.log(video_time);
                     form.append("token", token); // 文件对象
                     form.append("file", fileObj); // 文件对象
                     form.append("fileDuration",parseInt(video_time*1000));//转成 毫秒 视频时长
                     form.append("periodPicture",img_url);//视频时长
                     form.append("teacherId",teacherId);
                     console.log(form);
                     xhr = new XMLHttpRequest(); // XMLHttpRequest 对象
                     xhr.open("post",url, true); //post方式，url为服务器请求地址，true 该参数规定请求是否异步处理。
                     xhr.onload = uploadComplete; //请求完成
                     xhr.onerror = uploadFailed; //请求失败
                     xhr.upload.onprogress = progressFunction;//【上传进度调用方法实现】
                     xhr.upload.onloadstart = function() { //上传开始执行方法
                         ot = new Date().getTime(); //设置上传开始时间
                         oloaded = 0; //设置上传开始时，以上传的文件大小为0
                     };
                     xhr.send(form); //开始上传，发送form数据

                 }
             })

         },300)
    }
    //上传进度实现方法，上传过程中会频繁调用该方法
    function progressFunction(evt){
        // event.total是需要传输的总字节，event.loaded是已经传输的字节。如果event.lengthComputable不为真，则event.total等于0
        if(evt.lengthComputable){
            $(".el-progress--line").css("display","block");
            /*进度条显示进度*/
            var bfb=Math.round(evt.loaded / evt.total * 100);
            $(".el-progress-bar__inner").css({"width":bfb+'%',"height":"100%","background":"red"});
            $(".el-progress__text").html(bfb + "%");
        }

        var time = document.getElementById("time");
        var nt = new Date().getTime(); //获取当前时间
        var pertime = (nt - ot) / 1000; //计算出上次调用该方法时到现在的时间差，单位为s
        ot = new Date().getTime(); //重新赋值时间，用于下次计算

        var perload = evt.loaded - oloaded; //计算该分段上传的文件大小，单位b
        oloaded = evt.loaded; //重新赋值已上传文件大小，用以下次计算

        //上传速度计算
        var speed = perload / pertime; //单位b/s
        var bspeed = speed;
        var units = 'b/s'; //单位名称
        if(speed / 1024 > 1) {
            speed = speed / 1024;
            units = 'k/s';
        }
        if(speed / 1024 > 1) {
            speed = speed / 1024;
            units = 'M/s';
        }
        speed = speed.toFixed(1);
        //剩余时间
        var resttime = ((evt.total - evt.loaded) / bspeed).toFixed(1);
        time.innerHTML = '上传速度：' + speed + units + ',剩余时间：' + resttime + 's';
        if(bspeed == 0)
            time.innerHTML = '上传已取消';
    }
    //上传成功响应
    function uploadComplete(evt) {
        //服务端接收完文件返回的结果  注意返回json对象转换为数组
        if(evt.target.responseText){
            var data=JSON.parse(evt.target.responseText);
            console.log("上传成功！");
            $(".no_upload>.load_tit>.quit_upload").text("成功");
            location.href='./educational_administration.html';
//          $(".preview").append("<video  controls='' width='100%' autoplay='' name='media'><source src="+data.data+" type='video/mp4'></video>");

        }else{
            alert("上传失败");
        }
    }
    //上传失败
    function uploadFailed(evt) {
        alert("上传失败！");
    }
    $(function () {
        //默认渲染
        myVideo("/period/related/get/all/Period","my_video")
        /*点击 视频列表*/
        var type=2;
        // 视频上传的全部视频
        function myVideo(url,tem){
            myAjax({url:url,data:{teacherid:teacherId},type:'post'}, function (data) {
                console.log(data);
                if(data.status==200){
                    template.helper("str",function(str){

                        return str.split(",");
                    })
                    template.helper("time",function(time){
                        var timestamp=new Date().getTime();//当前时间戳
                        var kk=timestamp-time;//发表时的时间戳
                        var timea="";
                        var sec=parseInt(kk/1000);//秒
                        var min=parseInt(sec/60);//分
                        var hour=parseInt(min/60);//时
                        var day=parseInt(hour/24);//天
                        if(sec<60){
                            timea=sec+"秒前";
                        }else if(min<60){
                            timea=min+"分钟前";
                        }else if(hour<24){
                            timea=hour+"小时前";
                        }else if(day<7){
                            timea=day+"天前";
                        }else{
                            timea=new Date(time).toLocaleString().replace(/:\d{1,2}$/,' ').replace("/","-");
                        }
                        return timea;

                    });
                    $("#item1 .video_lists").html(template(tem,data));

                }
            })
        }
        // /period/related/get/all/Period
        // /period/related/get/already/Editor 已编辑的 teacherid
        //  /period/related/get/Not/Editor 未编辑的 teacherid
        $("#item1>h2>em").click(function () {
            $(this).addClass("active");
            $(this).siblings().removeClass("active");
            console.log($(this).data("type"));
            type=$(this).data("type");
            if(type==0){
                //未编辑
               myVideo("/period/related/get/Not/Editor","my_video");
            }else if(type==1){
                //已编辑
                myVideo("/period/related/get/already/Editor","my_video")
            }else{
                //全部
               myVideo("/period/related/get/all/Period","my_video")
            }

        })
        //我的视频
        var classEndingStatus=$(".lesson_status>.active").data("classendingstatus");
        var releaseStatus=$(".publish_status>.active").data("releasestatus");
        myClass(classEndingStatus,releaseStatus);

        function  myClass(classEndingStatus,releaseStatus){
            var obj={
                teacherid:teacherId,
                classEndingStatus:classEndingStatus,
                releaseStatus:releaseStatus
            }
            //获取  active 的
            myAjax({url:"/course/related/get/Course/List",data:obj,type:"post"}, function (data) {
                console.log(data);
                if(data.status==200){
                    template.helper("sum",function(a,b){

                        return a-0+b;
                    })
                    template.helper("time",function(date){
                        var time=new Date(date).toLocaleString().replace(/:\d{1,2}$/,' ').replace(/\//g,"-");
                        return time;
                        /* return new Date(parseInt(date) * 1000).toLocaleString().replace(/:\d{1,2}$/,' ');*/
                    });
                    $("#item2>.my_video_lists").html(template("mine",data))

                }
            })

        }
        /*点击 结课状态的 发布状态*/
        /*function status(ele,callback){
           ele.click(function () {
                $(this).siblings().removeClass("active");
                $(this).addClass("active");
               // console.log($(this).data(data));
               //获取 class=active 的 类名
               //callback();
            })

        }
        status($(".lesson_status>span"), function () {
            classendingstatus=$(this).data("classendingstatus");
          releaseStatus=$(".publish_status>.active").data("releasestatus");
            console.log(classendingstatus);
            console.log(releaseStatus);
            myClass(classendingstatus,releaseStatus);
        });*/
        $(".lesson_status>span").click(function () {
            $(this).siblings().removeClass("active");
            $(this).addClass("active");
            classendingstatus=$(this).data("classendingstatus");
            releaseStatus=$(".publish_status>.active").data("releasestatus");
            myClass(classendingstatus,releaseStatus);
        })
        //status($(".publish_status>span"),"releasestatus");
        $(".publish_status>span").click(function () {
            $(this).siblings().removeClass("active");
            $(this).addClass("active");
            classendingstatus=$(".lesson_status>span").data("classendingstatus");
            releaseStatus=$(this).data("releasestatus");
            myClass(classendingstatus,releaseStatus);
        })

        var str=[];
        $(".put_way").on("click",".sold_out", function () {
            var active = $("#item2 .active");
            for (var i = 0; i < active.length; i++) {
                //console.log($(".active")[i]);
                var that = active[i];
                str.push(that.getAttribute("data-id"));
            }
            console.log(str);
        })
       /* /!*删除我的视频 *!/
        $(".delete").click(function () {
            alert(1);
        })*/
    })
</script>
</html>